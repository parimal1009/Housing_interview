<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Housing System Interview Application</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .interview-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .question-section {
            margin-bottom: 30px;
        }

        .question-category {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 1.3rem;
            line-height: 1.6;
            color: #333;
            margin-bottom: 20px;
        }

        .question-counter {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
            font-size: 1rem;
        }

        .recording-section {
            text-align: center;
            margin: 30px 0;
        }

        .record-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 20px 40px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .record-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .record-button:active {
            transform: translateY(0);
        }

        .record-button.recording {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }
            50% { box-shadow: 0 4px 25px rgba(255, 107, 107, 0.6); }
            100% { box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }
        }

        .upload-section {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f9f9ff;
        }

        .upload-section.dragover {
            border-color: #667eea;
            background: #f0f0ff;
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        /* New styles for dual transcription boxes */
        .transcription-section {
            margin: 30px 0;
        }

        .transcription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .transcription-header h3 {
            color: #667eea;
            font-size: 1.2rem;
        }

        .transcription-toggle {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .transcription-toggle:hover {
            background: #5a6fd8;
        }

        .transcription-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .transcription-box-wrapper {
            position: relative;
        }

        .transcription-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            padding-left: 5px;
        }

        .raw-label {
            color: #dc3545;
        }

        .clean-label {
            color: #28a745;
        }

        .transcription-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            min-height: 120px;
            font-size: 0.95rem;
            line-height: 1.5;
            white-space: pre-wrap;
            width: 100%;
            resize: vertical;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .transcription-box.raw-text {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .transcription-box.clean-text {
            border-color: #28a745;
            background: #f8fff8;
        }

        .transcription-box.editing {
            background: white;
            border-color: #667eea;
            outline: none;
        }

        .transcription-box:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        /* Single box view for mobile */
        .single-transcription-view {
            display: none;
        }

        .transcription-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .transcription-tab {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .transcription-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .transcription-tab:hover {
            color: #667eea;
        }

        .transcription-info {
            font-size: 0.85rem;
            color: #666;
            margin-top: 10px;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .analysis-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .analysis-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .analysis-text {
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .report-section {
            margin-top: 30px;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .report-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .report-content {
            line-height: 1.8;
            white-space: pre-wrap;
            font-size: 1.1rem;
        }

        .welcome-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .start-interview-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .start-interview-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .audio-controls {
            margin: 20px 0;
            text-align: center;
        }

        .time-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .interview-card {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .question-text {
                font-size: 1.1rem;
            }

            .button-group {
                flex-direction: column;
                align-items: center;
            }

            /* Switch to single transcription view on mobile */
            .transcription-container {
                display: none;
            }

            .single-transcription-view {
                display: block;
            }

            .transcription-toggle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏠 Housing System Interview</h1>
            <p>Professional Housing Assessment Tool</p>
        </div>

        <div class="interview-card">
            <!-- Welcome Section -->
            <div id="welcome-section" class="welcome-section">
                <h2>Welcome to the Housing Assessment Interview</h2>
                <p style="margin: 20px 0; font-size: 1.1rem; line-height: 1.6;">
                    This interview will help us understand your current housing situation and identify ways we can better support you. 
                    The interview consists of 10 questions covering various aspects of your housing experience.
                </p>
                <p style="margin-bottom: 30px; color: #666;">
                    You can record your responses using the microphone or upload audio files. Your responses will be transcribed and analyzed to provide personalized recommendations.
                </p>
                <button class="start-interview-btn" onclick="startInterview()">Start Interview</button>
            </div>

            <!-- Interview Section (Initially Hidden) -->
            <div id="interview-section" style="display: none;">
                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>

                <!-- Question Counter -->
                <div class="question-counter" id="question-counter"></div>

                <!-- Question Section -->
                <div class="question-section">
                    <div class="question-category" id="question-category"></div>
                    <div class="question-text" id="question-text"></div>
                </div>

                <!-- Recording Section -->
                <div class="recording-section">
                    <button class="record-button" id="record-button" onclick="toggleRecording()">
                        🎤 Start Recording
                    </button>
                    <div class="time-display" id="time-display" style="display: none;">00:00</div>
                </div>

                <!-- File Upload Section -->
                <div class="upload-section" id="upload-section" onclick="document.getElementById('file-input').click()">
                    <div>📁 Or click here to upload an audio file</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        Supported formats: MP3, MP4, WAV, M4A
                    </div>
                    <input type="file" id="file-input" class="file-input" accept=".mp3,.mp4,.wav,.m4a" onchange="handleFileUpload(event)">
                </div>

                <!-- Audio Playback -->
                <div class="audio-controls" id="audio-controls" style="display: none;">
                    <audio id="audio-player" controls style="width: 100%; max-width: 400px;"></audio>
                </div>

                <!-- Enhanced Transcription Section -->
                <div class="transcription-section" id="transcription-section" style="display: none;">
                    <div class="transcription-header">
                        <h3>Transcription Results</h3>
                        <button class="transcription-toggle" id="transcription-toggle" onclick="toggleTranscriptionView()">
                            Switch to Single View
                        </button>
                    </div>

                    <!-- Dual transcription boxes (desktop) -->
                    <div class="transcription-container" id="transcription-container">
                        <div class="transcription-box-wrapper">
                            <label class="transcription-label raw-label">📝 Raw Transcription</label>
                            <textarea class="transcription-box raw-text" id="raw-transcription-text" readonly placeholder="Raw transcription will appear here..."></textarea>
                        </div>
                        <div class="transcription-box-wrapper">
                            <label class="transcription-label clean-label">✨ Cleaned Transcription</label>
                            <textarea class="transcription-box clean-text editing" id="clean-transcription-text" placeholder="Cleaned transcription will appear here..."></textarea>
                        </div>
                    </div>

                    <!-- Single transcription view (mobile) -->
                    <div class="single-transcription-view" id="single-transcription-view">
                        <div class="transcription-tabs">
                            <button class="transcription-tab active" onclick="switchTab('raw')">📝 Raw</button>
                            <button class="transcription-tab" onclick="switchTab('clean')">✨ Clean</button>
                        </div>
                        <div class="transcription-box-wrapper">
                            <textarea class="transcription-box" id="mobile-transcription-text" placeholder="Transcription will appear here..."></textarea>
                        </div>
                    </div>

                    <div class="transcription-info">
                        Raw transcription shows the direct output from speech-to-text. 
                        Cleaned transcription is processed for better readability and can be edited before submission.
                    </div>
                </div>

                <!-- Button Group -->
                <div class="button-group">
                    <button class="btn btn-secondary" id="retake-button" onclick="retakeResponse()" style="display: none;">
                        🔄 Retake
                    </button>
                    <button class="btn btn-primary" id="submit-button" onclick="submitResponse()" style="display: none;">
                        Submit Response
                    </button>
                    <button class="btn btn-success" id="next-button" onclick="nextQuestion()" style="display: none;">
                        Next Question →
                    </button>
                </div>

                <!-- Analysis Section -->
                <div class="analysis-section" id="analysis-section" style="display: none;">
                    <h3>Response Analysis</h3>
                    <div class="analysis-text" id="analysis-text"></div>
                </div>

                <!-- Status Messages -->
                <div id="status-messages"></div>
            </div>

            <!-- Report Section -->
            <div class="report-section" id="report-section" style="display: none;">
                <h2>📋 Interview Summary Report</h2>
                <div class="report-content" id="report-content"></div>
                <div class="button-group" style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="downloadReport()">
                        📄 Download Report
                    </button>
                    <button class="btn btn-secondary" onclick="startNewInterview()">
                        🔄 New Interview
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let sessionId = null;
        let currentQuestion = 0;
        let totalQuestions = 10;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null;
        let timerInterval = null;
        let currentAudioBlob = null;
        let isDualView = true;
        let currentMobileTab = 'raw';

        // Start interview
        async function startInterview() {
            try {
                const response = await fetch('/start_session', {
                    method: 'POST'
                });
                const data = await response.json();
                
                sessionId = data.session_id;
                totalQuestions = data.total_questions;
                
                document.getElementById('welcome-section').style.display = 'none';
                document.getElementById('interview-section').style.display = 'block';
                
                loadQuestion(0);
                showStatusMessage('Interview started successfully!', 'success');
            } catch (error) {
                showStatusMessage('Failed to start interview: ' + error.message, 'error');
            }
        }

        // Load question
        async function loadQuestion(questionNum) {
            try {
                const response = await fetch(`/get_question/${sessionId}?question_num=${questionNum}`);
                const data = await response.json();
                
                if (data.completed) {
                    await generateFinalReport();
                    return;
                }
                
                const question = data.question;
                currentQuestion = questionNum;
                
                // Update UI
                document.getElementById('question-counter').textContent = 
                    `Question ${data.question_number} of ${data.total_questions}`;
                document.getElementById('question-category').textContent = question.category;
                document.getElementById('question-text').textContent = question.question;
                document.getElementById('progress-fill').style.width = `${data.progress}%`;
                
                // Reset UI state
                resetQuestionState();
                
            } catch (error) {
                showStatusMessage('Failed to load question: ' + error.message, 'error');
            }
        }

        // Toggle recording
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        // Start recording
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    currentAudioBlob = audioBlob;
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    const audioPlayer = document.getElementById('audio-player');
                    audioPlayer.src = audioUrl;
                    document.getElementById('audio-controls').style.display = 'block';
                    
                    // Transcribe audio
                    transcribeAudio(audioBlob);
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                const recordButton = document.getElementById('record-button');
                recordButton.textContent = '⏹️ Stop Recording';
                recordButton.classList.add('recording');
                
                // Start timer
                recordingStartTime = Date.now();
                document.getElementById('time-display').style.display = 'block';
                timerInterval = setInterval(updateTimer, 1000);
                
                showStatusMessage('Recording started...', 'info');
                
            } catch (error) {
                showStatusMessage('Microphone access denied or not available', 'error');
            }
        }

        // Stop recording
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                
                // Update UI
                const recordButton = document.getElementById('record-button');
                recordButton.textContent = '🎤 Start Recording';
                recordButton.classList.remove('recording');
                
                // Stop timer
                clearInterval(timerInterval);
                document.getElementById('time-display').style.display = 'none';
                
                showStatusMessage('Recording completed! Transcribing...', 'success');
            }
        }

        // Update timer display
        function updateTimer() {
            if (recordingStartTime) {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('time-display').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                currentAudioBlob = file;
                const audioUrl = URL.createObjectURL(file);
                
                const audioPlayer = document.getElementById('audio-player');
                audioPlayer.src = audioUrl;
                document.getElementById('audio-controls').style.display = 'block';
                
                showStatusMessage('File uploaded! Transcribing...', 'info');
                transcribeAudio(file);
            }
        }

        // Transcribe audio
        async function transcribeAudio(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio_file', audioBlob, 'recording.webm');
                
                showStatusMessage('Transcribing audio...', 'info');
                
                const response = await fetch(`/transcribe_audio/${sessionId}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Transcription failed');
                }
                
                const data = await response.json();
                const rawTranscription = data.transcription.raw_text || '';
                const cleanedTranscription = data.transcription.cleaned_text || rawTranscription;
                
                // Display transcriptions in both boxes
                document.getElementById('raw-transcription-text').value = rawTranscription;
                document.getElementById('clean-transcription-text').value = cleanedTranscription;
                
                // Update mobile view
                updateMobileTranscription();
                
                // Show transcription section
                document.getElementById('transcription-section').style.display = 'block';
                document.getElementById('submit-button').style.display = 'inline-block';
                document.getElementById('retake-button').style.display = 'inline-block';
                
                showStatusMessage('Transcription completed! You can edit the cleaned version before submitting.', 'success');
                
            } catch (error) {
                showStatusMessage('Transcription failed: ' + error.message, 'error');
            }
        }

        // Toggle transcription view (dual/single)
        function toggleTranscriptionView() {
            isDualView = !isDualView;
            const container = document.getElementById('transcription-container');
            const singleView = document.getElementById('single-transcription-view');
            const toggleButton = document.getElementById('transcription-toggle');
            
            if (isDualView) {
                container.style.display = 'grid';
                singleView.style.display = 'none';
                toggleButton.textContent = 'Switch to Single View';
            } else {
                container.style.display = 'none';
                singleView.style.display = 'block';
                toggleButton.textContent = 'Switch to Dual View';
                updateMobileTranscription();
            }
        }

        // Switch mobile transcription tabs
        function switchTab(tab) {
            currentMobileTab = tab;
            
            // Update tab buttons
            const tabs = document.querySelectorAll('.transcription-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update content
            updateMobileTranscription();
        }

        // Update mobile transcription content
        function updateMobileTranscription() {
            const mobileText = document.getElementById('mobile-transcription-text');
            const rawText = document.getElementById('raw-transcription-text').value;
            const cleanText = document.getElementById('clean-transcription-text').value;
            
            if (currentMobileTab === 'raw') {
                mobileText.value = rawText;
                mobileText.readOnly = true;
                mobileText.classList.remove('editing');
                mobileText.classList.add('raw-text');
                mobileText.classList.remove('clean-text');
            } else {
                mobileText.value = cleanText;
                mobileText.readOnly = false;
                mobileText.classList.add('editing');
                mobileText.classList.remove('raw-text');
                mobileText.classList.add('clean-text');
            }
        }

        // Submit response
        async function submitResponse() {
            try {
                // Get the cleaned transcription text (editable one)
                let transcriptionText;
                if (isDualView || window.innerWidth > 768) {
                    transcriptionText = document.getElementById('clean-transcription-text').value;
                } else {
                    // For mobile single view, sync back to clean text if editing clean tab
                    if (currentMobileTab === 'clean') {
                        const mobileText = document.getElementById('mobile-transcription-text').value;
                        document.getElementById('clean-transcription-text').value = mobileText;
                    }
                    transcriptionText = document.getElementById('clean-transcription-text').value;
                }
                
                const rawTranscriptionText = document.getElementById('raw-transcription-text').value;
                
                if (!transcriptionText.trim()) {
                    showStatusMessage('Please provide a response before submitting.', 'error');
                    return;
                }
                
                const formData = new FormData();
                formData.append('question_id', currentQuestion + 1);
                formData.append('raw_transcription', rawTranscriptionText);
                formData.append('cleaned_transcription', transcriptionText);
                
                showStatusMessage('Analyzing response...', 'info');
                
                const response = await fetch(`/submit_response/${sessionId}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Failed to submit response');
                }
                
                const data = await response.json();
                
                // Display analysis
                if (data.analysis && data.analysis.analysis) {
                    document.getElementById('analysis-text').textContent = data.analysis.analysis;
                    document.getElementById('analysis-section').style.display = 'block';
                }
                
                // Show next button or complete interview
                if (data.next_question) {
                    document.getElementById('next-button').style.display = 'inline-block';
                    showStatusMessage('Response submitted successfully!', 'success');
                } else {
                    showStatusMessage('Interview completed! Generating final report...', 'success');
                    setTimeout(generateFinalReport, 2000);
                }
                
                // Hide submit and retake buttons
                document.getElementById('submit-button').style.display = 'none';
                document.getElementById('retake-button').style.display = 'none';
                
            } catch (error) {
                showStatusMessage('Failed to submit response: ' + error.message, 'error');
            }
        }

        // Next question
        function nextQuestion() {
            loadQuestion(currentQuestion + 1);
        }

        // Retake response
        function retakeResponse() {
            resetQuestionState();
            showStatusMessage('Ready to record new response', 'info');
        }

        // Reset question state
        function resetQuestionState() {
            document.getElementById('audio-controls').style.display = 'none';
            document.getElementById('transcription-section').style.display = 'none';
            document.getElementById('analysis-section').style.display = 'none';
            document.getElementById('submit-button').style.display = 'none';
            document.getElementById('retake-button').style.display = 'none';
            document.getElementById('next-button').style.display = 'none';
            
            // Clear transcription boxes
            document.getElementById('raw-transcription-text').value = '';
            document.getElementById('clean-transcription-text').value = '';
            document.getElementById('mobile-transcription-text').value = '';
            
            currentAudioBlob = null;
        }

        // Generate final report
        async function generateFinalReport() {
            try {
                showStatusMessage('Generating comprehensive report...', 'info');
                
                const response = await fetch(`/generate_report/${sessionId}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Display report
                document.getElementById('report-content').textContent = data.summary_report;
                document.getElementById('interview-section').style.display = 'none';
                document.getElementById('report-section').style.display = 'block';
                
                showStatusMessage('Report generated successfully!', 'success');
                
            } catch (error) {
                showStatusMessage('Failed to generate report: ' + error.message, 'error');
            }
        }

        // Download report
        function downloadReport() {
            const reportContent = document.getElementById('report-content').textContent;
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `housing_interview_report_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Start new interview
        function startNewInterview() {
            location.reload();
        }

        // Show status message
        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('status-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message status-${type}`;
            messageDiv.textContent = message;
            
            statusDiv.innerHTML = '';
            statusDiv.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Drag and drop handlers
        const uploadSection = document.getElementById('upload-section');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('audio/')) {
                    document.getElementById('file-input').files = files;
                    handleFileUpload({ target: { files: files } });
                } else {
                    showStatusMessage('Please drop an audio file', 'error');
                }
            }
        });

        // Handle window resize for responsive transcription view
        window.addEventListener('resize', () => {
            if (window.innerWidth <= 768) {
                // Switch to mobile view
                document.getElementById('transcription-container').style.display = 'none';
                document.getElementById('single-transcription-view').style.display = 'block';
                document.getElementById('transcription-toggle').style.display = 'none';
                updateMobileTranscription();
            } else {
                // Switch back to desktop view
                if (isDualView) {
                    document.getElementById('transcription-container').style.display = 'grid';
                    document.getElementById('single-transcription-view').style.display = 'none';
                }
                document.getElementById('transcription-toggle').style.display = 'block';
            }
        });

        // Sync mobile transcription changes back to desktop boxes
        document.addEventListener('DOMContentLoaded', function() {
            const mobileTextarea = document.getElementById('mobile-transcription-text');
            
            mobileTextarea.addEventListener('input', function() {
                if (currentMobileTab === 'clean') {
                    document.getElementById('clean-transcription-text').value = this.value;
                }
            });
            
            showStatusMessage('Application loaded successfully! Click "Start Interview" to begin.', 'success');
        });
    </script>
</body>
</html>